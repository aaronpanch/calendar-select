<link rel="import" href="../polymer/polymer.html">

<script src="bower_components/moment/min/moment.min.js"></script>

<!--
A sweet calendar selector widget!

# Default Usage

Simply add the `<calendar-select>` element to the page, and you're off!

    <calendar-select></calendar-select>

@demo
-->
<dom-module id="calendar-select">

  <style>
    :host {
      display: inline-block;
      box-sizing: border-box;
      text-align: center;
    }

    .calendar-select__calendar {
      width: 100%;
    }
  </style>

  <template>
    <h1>{{_monthName(_currentMonth)}}</h1>
    <button on-tap="previousMonth">prev</button>
    <button on-tap="nextMonth">next</button>
    <table class="calendar-select__calendar">
      <thead>
        <tr>
          <template is="dom-repeat" items="[[_dayNames()]]">
            <th>[[item]]</th>
          </template>
        </tr>
      </thead>
      <tbody>
        <template is="dom-repeat" items="[[_generateWeeks(_visibleWeeks)]]">
          <tr>
            <template is="dom-repeat" items="[[item]]">
              <td>[[item.date]]</td>
            </template>
          </tr>
        </template>
      </tbody>
    </table>
  </template>

</dom-module>

<script>

  Polymer({

    is: 'calendar-select',

    properties: {
      /**
       * Specify the selected date for the calendar. Can be specified as a string.
       *
       * @default Today
       */
      selectedDate: {
        type: Date,
        value: function() {
          return new Date();
        },
        observer: '_updateCurrentMonth'
      },

      _currentMonth: {
        type: Object,
        readOnly: true,
        observer: '_updateVisibleWeeks'
      },

      _visibleWeeks: {
        type: Object,
        readOnly: true
      }
    },

    // Element Lifecycle

    ready: function() {
    },

    /**
     * Moves the calendar to the previous month.
     *
     * @return {Object} The moment object for the first of the previous month.
     */
    previousMonth: function() {
      return this._set_currentMonth(this._currentMonth.clone().subtract(1, 'month'));
    },

    /**
     * Moves the calendar to the next month.
     *
     * @return {Object} The moment object for the first of the next month.
     */
    nextMonth: function() {
      return this._set_currentMonth(this._currentMonth.clone().add(1, 'month'));
    },

    _updateCurrentMonth: function() {
      return this._set_currentMonth(moment(this.selectedDate).startOf('month'));
    },

    _updateVisibleWeeks: function(newMonth, oldMonth) {
      if (oldMonth) {
        if (oldMonth.isBefore(newMonth)) {
          this._set_visibleWeeks({
            start: oldMonth,
            end: newMonth.clone().add(6, 'weeks')
          });
        } else {
          this._set_visibleWeeks({
            start: newMonth,
            end: oldMonth.clone().add(6, 'weeks')
          });
        }
      } else {
        this._set_visibleWeeks({
          start: newMonth,
          end: newMonth.clone().add(6, 'weeks')
        });
      }
    },

    _dayNames: function() {
      return moment.weekdaysShort();
    },

    _monthName: function(selectedMoment) {
      return selectedMoment.format('MMMM');
    },

    _generateWeeks: function(visibleWeeks) {
      var cursor = visibleWeeks.start.clone().startOf('week').subtract(1, 'day'),
          numWeeks = visibleWeeks.end.diff(visibleWeeks.start, 'weeks');
      return Array.apply(null, new Array(numWeeks)).map(function () {
        return Array.apply(null, new Array(7)).map(function () {
          var currentMoment = cursor.add(1, 'day');
          return {
            date: currentMoment.date()
          }
        });
      });
    }
  });

</script>
